- pipeline: "Terraform CI"
  trigger_mode: "ON_EVERY_PUSH"
  ref_name: "refs/heads/*"
  ref_type: "WILDCARD"
  auto_clear_cache: true
  fail_on_prepare_env_warning: true
  trigger_condition: "ALWAYS"
  actions:
  - action: "Execute: terraform plan -out tfapply -var-file terraform.tfvars"
    type: "BUILD"
    working_directory: "/buddy/terraform"
    docker_image_name: "library/ubuntu"
    docker_image_tag: "18.04"
    execute_commands:
    - "cp ci_backend.tf ./google/backend.tf"
    - "cd google"
    - "gpg --batch --yes --passphrase=\"$PASS_PHRASE\"\\"
    - "    --output github_credential.json\\"
    - "     --decrypt github_credential.json.gpg"
    - "       "
    - "cat <<EOF >terraform.tfvars"
    - "project_id           = \"$PROJECT_ID\""
    - "bastion_members      = $BASTION_MEMBERS"
    - "ip_source_ranges_ssh = $IP_SOURCE_RANGES_SSH"
    - "cluster_name         = \"$CLUSTER_NAME\""
    - "cred_file            = \"github_credential.json\""
    - "EOF"
    - ""
    - "terraform init -input=false"
    - "terraform plan -out tfapply -var-file terraform.tfvars"
    setup_commands:
    - " # Install pre-reqs for installing Terraform"
    - " apt-get update && apt-get install -y curl gnupg2 lsb-release software-properties-common git"
    - " curl -fsSL https://apt.releases.hashicorp.com/gpg | apt-key add -"
    - " apt-add-repository \"deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main\""
    - " apt-get update && apt-get install -y terraform=0.12.29"
    volume_mappings:
    - "/:/buddy/terraform"
    trigger_condition: "ALWAYS"
    shell: "BASH"
  - action: "Send notification to beeraspberry channel"
    type: "SLACK"
    content: "[#$BUDDY_EXECUTION_ID] $BUDDY_PIPELINE_NAME execution by <$BUDDY_INVOKER_URL|$BUDDY_INVOKER_NAME>"
    blocks: "[{\"type\":\"section\",\"fields\":[{\"type\":\"mrkdwn\",\"text\":\"*Successful execution:* <$BUDDY_EXECUTION_URL|Execution #$BUDDY_EXECUTION_ID $BUDDY_EXECUTION_COMMENT>\"},{\"type\":\"mrkdwn\",\"text\":\"*Pipeline:* <$BUDDY_PIPELINE_URL|$BUDDY_PIPELINE_NAME>\"},{\"type\":\"mrkdwn\",\"text\":\"*Branch:* $BUDDY_EXECUTION_BRANCH\"},{\"type\":\"mrkdwn\",\"text\":\"*Project:* <$BUDDY_PROJECT_URL|$BUDDY_PROJECT_NAME>\"}]}]"
    channel: "C0142QK10SU"
    channel_name: "beeraspberry"
    trigger_condition: "ALWAYS"
    integration_hash: "5f5432a963ad6874868e4bf1"
  - action: "Send notification to beeraspberry channel"
    type: "SLACK"
    trigger_time: "ON_FAILURE"
    content: "[#$BUDDY_EXECUTION_ID] $BUDDY_PIPELINE_NAME execution by <$BUDDY_INVOKER_URL|$BUDDY_INVOKER_NAME>"
    blocks: "[{\"type\":\"section\",\"fields\":[{\"type\":\"mrkdwn\",\"text\":\"*Failed execution:* <$BUDDY_EXECUTION_URL|Execution #$BUDDY_EXECUTION_ID $BUDDY_EXECUTION_COMMENT>\"},{\"type\":\"mrkdwn\",\"text\":\"*Pipeline:* <$BUDDY_PIPELINE_URL|$BUDDY_PIPELINE_NAME>\"},{\"type\":\"mrkdwn\",\"text\":\"*Branch:* $BUDDY_EXECUTION_BRANCH\"},{\"type\":\"mrkdwn\",\"text\":\"*Project:* <$BUDDY_PROJECT_URL|$BUDDY_PROJECT_NAME>\"}]}]"
    channel: "C0142QK10SU"
    channel_name: "beeraspberry"
    trigger_condition: "ALWAYS"
    integration_hash: "5f5432a963ad6874868e4bf1"
- pipeline: "Terraform Deploy GCP"
  trigger_mode: "MANUAL"
  ref_name: "master"
  ref_type: "BRANCH"
  auto_clear_cache: true
  fail_on_prepare_env_warning: true
  trigger_condition: "ALWAYS"
  actions:
  - action: "Wait for approval"
    type: "WAIT_FOR_APPLY"
    disabled: true
    comment: "Do you want to approve this deployment"
    trigger_condition: "SUCCESS_PIPELINE"
    trigger_project_name: "terraform"
    trigger_pipeline_name: "Terraform CI"
  - action: "Deploy to GCP"
    type: "BUILD"
    disabled: true
    working_directory: "/buddy/terraform"
    docker_image_name: "library/ubuntu"
    docker_image_tag: "18.04"
    execute_commands:
    - "cd google"
    - "gpg --batch --yes --passphrase=\"$PASS_PHRASE\"\\"
    - "    --output github_credential.json\\"
    - "     --decrypt github_credential.json.gpg"
    - "       "
    - "cat <<EOF >terraform.tfvars"
    - "project_id           = \"$PROJECT_ID\""
    - "bastion_members      = $BASTION_MEMBERS"
    - "ip_source_ranges_ssh = $IP_SOURCE_RANGES_SSH"
    - "cluster_name         = \"$GCP_CLUSTER_NAME\""
    - "cred_file            = \"github_credential.json\""
    - "EOF"
    - ""
    - "terraform init -input=false"
    - "terraform plan -out tfapply -var-file terraform.tfvars"
    - "terraform apply tfapply"
    setup_commands:
    - " # Install pre-reqs for installing Terraform"
    - " apt-get update && apt-get install -y curl gnupg2 lsb-release software-properties-common git"
    - " curl -fsSL https://apt.releases.hashicorp.com/gpg | apt-key add -"
    - " apt-add-repository \"deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main\""
    - " apt-get update && apt-get install -y terraform=0.12.29"
    volume_mappings:
    - "/:/buddy/terraform"
    trigger_condition: "ALWAYS"
    shell: "BASH"
    variables:
    - key: "GCP_CLUSTER_NAME"
      value: "buddy-cluster"
  - action: "Send notification to beeraspberry channel"
    type: "SLACK"
    disabled: true
    content: "[#$BUDDY_EXECUTION_ID] $BUDDY_PIPELINE_NAME execution by <$BUDDY_INVOKER_URL|$BUDDY_INVOKER_NAME>"
    blocks: "[{\"type\":\"section\",\"fields\":[{\"type\":\"mrkdwn\",\"text\":\"*Successful execution:* <$BUDDY_EXECUTION_URL|Execution #$BUDDY_EXECUTION_ID $BUDDY_EXECUTION_COMMENT>\"},{\"type\":\"mrkdwn\",\"text\":\"*Pipeline:* <$BUDDY_PIPELINE_URL|$BUDDY_PIPELINE_NAME>\"},{\"type\":\"mrkdwn\",\"text\":\"*Branch:* $BUDDY_EXECUTION_BRANCH\"},{\"type\":\"mrkdwn\",\"text\":\"*Project:* <$BUDDY_PROJECT_URL|$BUDDY_PROJECT_NAME>\"}]}]"
    channel: "C0142QK10SU"
    channel_name: "beeraspberry"
    trigger_condition: "ALWAYS"
    integration_hash: "5f5432a963ad6874868e4bf1"
  - action: "Send notification to beeraspberry channel"
    type: "SLACK"
    trigger_time: "ON_FAILURE"
    content: "[#$BUDDY_EXECUTION_ID] $BUDDY_PIPELINE_NAME execution by <$BUDDY_INVOKER_URL|$BUDDY_INVOKER_NAME>"
    blocks: "[{\"type\":\"section\",\"fields\":[{\"type\":\"mrkdwn\",\"text\":\"*Failed execution:* <$BUDDY_EXECUTION_URL|Execution #$BUDDY_EXECUTION_ID $BUDDY_EXECUTION_COMMENT>\"},{\"type\":\"mrkdwn\",\"text\":\"*Pipeline:* <$BUDDY_PIPELINE_URL|$BUDDY_PIPELINE_NAME>\"},{\"type\":\"mrkdwn\",\"text\":\"*Branch:* $BUDDY_EXECUTION_BRANCH\"},{\"type\":\"mrkdwn\",\"text\":\"*Project:* <$BUDDY_PROJECT_URL|$BUDDY_PROJECT_NAME>\"}]}]"
    channel: "C0142QK10SU"
    channel_name: "beeraspberry"
    trigger_condition: "ALWAYS"
    integration_hash: "5f5432a963ad6874868e4bf1"
