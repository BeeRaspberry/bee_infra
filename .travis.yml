dist: bionic

install:
  - curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
  - sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
  - sudo apt-get update && sudo apt-get install terraform=0.12.29
  - terraform -help

jobs:
  include:
    - stage: run_terraform                
      name: "Run Terraform"
      script: 
        - sudo apt-cache policy terraform
        - cp ci_backend.tf ./google/backend.tf
        - cd google
        - gpg --quiet --batch --yes -d --passphrase="$PASS_PHRASE" \
            -o github_credential.json github_credential.json.gpg
        - |
          cat <<EOF >terraform.tfvars
          project_id           = "$PROJECT_ID"
          bastion_members      = $BASTION_MEMBERS
          ip_source_ranges_ssh = $IP_SOURCE_RANGES_SSH
          cluster_name         = "$CLUSTER_NAME"
          cred_file            = "github_credential.json"
          EOF
        - terraform init -input=false
        - terraform plan -out tfapply -var-file terraform.tfvars